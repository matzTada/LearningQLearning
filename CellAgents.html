<html>
<head>
  <meta charset="UTF-8">

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">

  <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

  <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.min.js"></script>

  <style>
    body {padding: 0; margin: 0;} /* to avoid to show scroll bars*/
    canvas {
      height: 100vh;
		  width: 100%;
		  position: relative;
		  left: 0;
		  top: 0;
      /* display: block; */
      }  /* to avoid to show scroll bars*/
  </style>
</head>
<body>
  <!-- <div class="container-fluid">
    <div class="col"> -->
      <div id="p5canvas"></div>
    <!-- </div>
  </div> -->
</body>

<script language="javascript" type="text/javascript">

var loopflag = true;

function mouseClicked(){
  if(loopflag == true){
    noLoop();
  }else{
    loop();
  }
  loopflag = !loopflag;
}

var environment = [];
var env_width = 8;
var env_height = 8;
var cell_size = 0;

var agent1 = {x : 0,y : 0,}
var q_table = [];
var goal = {x : 0,y : 0,}

function setup() {
  for (var h = 0; h < env_height; h++) environment.push(new Array(env_width).fill(-1)) // initialize environment

  for (var i = 0; i < env_width*env_height/10; i++) { // set obstacles
    environment[floor(random(0,env_height))][floor(random(0,env_width))] = -100;
  }

  agent1.x = floor(random(0,env_width));
  agent1.y = floor(random(0,env_height));

  goal.x = floor(random(0,env_width));
  goal.y = floor(random(0,env_height));
  environment[goal.y][goal.x] = 100;

  // initialize q_table
  for (var i = 0; i < env_height*env_width; i++) q_table.push(new Array(4).fill(0))
  // --- detail of q_table ---
  // 2 dimensional array. line direction for each state. columns direction for each action of agent
  // (state number = index number) = (line)*env_width+(colums)
  // i.e. imagine env_height = 4, env_width = 4
  //   (x,y) = (0,3) => state number is 3
  //   (x,y) = (2,1) => state number is 2 * 1 + 4 = 6

  // --- p5 js initialize start ---
  var can = createCanvas($("#p5canvas").width(), windowHeight);
  can.parent("p5canvas");
  // --- p5 js initialize end ---
  colorMode(HSB, 100);
  frameRate(32);

  // for visulize
  cell_size = min(width/env_width, height/env_height);
}

function draw() {
  background(0);

  for (var h = 0; h < env_height; h++) {
    for (var w = 0; w < env_width; w++) {
      stroke(0);
      if(environment[h][w] == -100) {
        fill(0, 50, 100)
      }else if(environment[h][w] == 100) {
        fill(33, 50, 100)
      }else{
        fill(66, 50, 100)
      }
      rect(cell_size*w, cell_size*h, cell_size, cell_size)

      fill(0);
      textSize(height/q_table.length/2)
      textAlign(CENTER, CENTER);
      text(environment[h][w], cell_size*(w+0.5), cell_size*(h+0.5));

      noStroke();
      fill(255);
      var circlesize = cell_size/3;
      var state_q_value_max = max(q_table[getstate(h, w)]);
      var state_q_value_min = min(q_table[getstate(h, w)]);
      (q_table[getstate(h, w)][0] >= state_q_value_max) ? fill(255) : noFill();
      triangle_directed(cell_size*(w+0.5), cell_size*h, circlesize, HALF_PI);
      (q_table[getstate(h, w)][1] >= state_q_value_max) ? fill(255) : noFill();
      triangle_directed(cell_size*(w+0.5), cell_size*(h+1), circlesize, -HALF_PI);
      (q_table[getstate(h, w)][2] >= state_q_value_max) ? fill(255) : noFill();
      triangle_directed(cell_size*w, cell_size*(h+0.5), circlesize, 0);
      (q_table[getstate(h, w)][3] >= state_q_value_max) ? fill(255) : noFill();
      triangle_directed(cell_size*(w+1), cell_size*(h+0.5), circlesize, PI);

      noStroke();
      fill(0);
      textSize(height/q_table.length/2)
      textAlign(CENTER, TOP)
      text(nfc(q_table[getstate(h, w)][0], 1), cell_size*(w+0.5), cell_size*h);
      textAlign(CENTER, BOTTOM)
      text(nfc(q_table[getstate(h, w)][1], 1), cell_size*(w+0.5), cell_size*(h+1));
      textAlign(LEFT, CENTER)
      text(nfc(q_table[getstate(h, w)][2], 1), cell_size*w, cell_size*(h+0.5));
      textAlign(RIGHT, CENTER)
      text(nfc(q_table[getstate(h, w)][3], 1), cell_size*(w+1), cell_size*(h+0.5));

    }
  }

  stroke(255);
  fill(255);
  ellipse(cell_size*(agent1.x+0.5), cell_size*(agent1.y+0.5), cell_size/2, cell_size/2)

  // stroke(255);
  // fill(0);
  // rect(cell_size*goal.x, cell_size*goal.y, cell_size, cell_size)

  // visualize q_table
  for (var h = 0; h < q_table.length; h++) {
    for (var w = 0; w < q_table[0].length; w++) {
      stroke(255);
      fill(255);
      textAlign(LEFT, TOP)
      textSize(height/q_table.length/4)
      text(nfc(q_table[h][w], 1), cell_size*env_width+(width-cell_size*env_width)*w/q_table[0].length, height*h/q_table.length)
    }
  }

  // --- logic ---
  var nextpos = {x: agent1.x, y: agent1.y};
  var nextaction = floor(random(0,4));
  var movementflag = true;
  switch (nextaction) {
    case 0: (nextpos.y!=0)?nextpos.y -= 1:movementflag=false; break;
    case 1: (nextpos.y!=env_height-1)?nextpos.y += 1:movementflag=false; break;
    case 2: (nextpos.x!=0)?nextpos.x -= 1:movementflag=false; break;
    case 3: (nextpos.x!=env_width-1)?nextpos.x += 1:movementflag=false; break;
  }
  var currentstate = getstate(agent1.y, agent1.x);
  var nextstate = getstate(nextpos.y, nextpos.x);

  var alpha = 0.7;
  var gamma = 0.9; // time discount
  var q_value = alpha*(environment[agent1.y][agent1.x]+gamma*max(q_table[nextstate]))
    +(1-alpha)*environment[agent1.y][agent1.x];
  if(movementflag == false) q_value = -100;
  q_table[currentstate][nextaction] = q_value;

  // console.log("agent1", agent1)
  // console.log("currentstate", currentstate)
  // console.log("nextaction", nextaction)
  // console.log("nextpos", nextpos)
  // console.log("nextstate", nextstate)
  // console.log("q_value", q_value)

  agent1.x = nextpos.x;
  agent1.y = nextpos.y;

  noStroke();
  fill(255);
  textAlign(RIGHT, BOTTOM)
  textSize(height/40);
  text("frameRate():" + nfc(frameRate(),1), width, height);
}

function getstate(_y, _x){
  return _y*env_width+_x;
}

function triangle_directed(_x, _y, _height, _angle){
  push();
  translate(_x, _y);
  rotate(-HALF_PI/2+_angle);
  triangle(0, 0, _height*sqrt(2), 0, 0, _height*sqrt(2));
  pop();
}

</script>

</html>
